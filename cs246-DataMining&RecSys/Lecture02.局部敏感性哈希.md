# 局部敏感哈希

## 局部敏感性哈希算法

### 问题背景

​	  我们时常会碰到一些比较大量样本相似性，并选择出和输入的内容最相似的样本，淘宝提供的拍照识别商品功能，可以找到和拍摄照片最相似的商品推荐给用户，事实上这一类问题都可以归结为找到最相似的集合这一目标上，也就是在高维空间中找到相近的邻居，常见的例子有：

- 文本查重，找文档之间的相似度
- 图像的识别
- 推荐系统和搜索引擎

一般来说，在给定一些高维数据点$x_i$和距离度量函数$d(x_i,x_j)$的情况下找到和输入q比较接近的数据点满足$d(q,x_i)\le S$(即邻居)的时间复杂度是线性的，而找到这些样本中所有满足$d(x_i,x_j)\le S$的点对的时间复杂度是平方级别的，一旦数据量大起来，算法就会消耗大量时间，而这门课的重点内容就是“挖掘海量数据集”(课程名)，因此我们需要想办法将“找相似样本”的时间复杂度降低。



### 算法的描述

​	  局部敏感性哈希就是用来解决上面这个问题的，事实上这是一大类算法，这类算法的基本思想是将一系列item映射到一个个bucket中去，然后将需要判别的数据也进行映射，同一个bucket里的样本存在比较高的相似性，但是这样的方法也会产生false negative的情况，也就是说本来相似的item可能不会被分到一个bucket中。

![image-20210728202919722](static/image-20210728202919722.png)

我们也很容易发现局部敏感性哈希的关键就在于怎么定义一个有良好区分度的hash函数。



### 实例：相似文档检索

​	  面对海量的文档数据的时候，找到相似的文档是一件时间复杂度非常高的事情，这时候就可以用局部敏感性哈希，具体可以分成如下三个步骤：

- Shingling：将文档转化成一个向量表示，比如用某个单词是否出现为标准形成一个K维的布尔向量
- Min-Hashing：将文档的表示转化成一些简短的signatures，并且保留相似度相关的信息(实际上是一种降维)
- 局部敏感性哈希：使用得到的简短signatures进行局部敏感性哈希操作

![image-20210728205908367](static/image-20210728205908367.png)

#### Shingling

​	  这个步骤就是将文档转化成一个特征表示，一个`K-shingle`(也叫做K-gram)就是用k个文档中连续出现的token来表示一个文档，这里的token可以是字符也可以是单词，对于比较长的shingles可以将其进行压缩，一个文档可以用多个`K-shingle`来表示，一般来说内容相近的文档也会有多个相同的shingles

​	  我们假设每个文档$D_i$是用一系列`K-shingle`表示的，即$C_i=S(D_i)$，我们可以定义两个文档之间的相似度，常见的有Jaccard相似度：
$$
sim(D_1.D_2)=\frac{|C_1\cap C_2|}{|C_1\cup C_2|}
$$
而Jaccard距离可以定义成
$$
d(C_1,C_2)=1-sim(D_1,D_2)
$$
然后对于n篇文档，可以统计所有出现过的K-shingles并用0-1矩阵来表示一系列文档的特征：

<img src="static/image-20210731212559726.png" alt="image-20210731212559726" style="zoom:33%;" />

#### 最小哈希

​	  下一步我们需要使用最小哈希Min-Hashing将比较大的特征集合转化成小的signature并保留相似度的信息，我们可以使用哈希函数来实现这个目标，我们可以将不同的文档映射到一系列桶中，并且让相似的文档映射到同一个桶里。

​	  我们的目标实际上就变成了，对于相似度高的文档让它们的哈希值相等，而对于不相似的文档，让它们的哈希值不相等，很显然哈希函数的选取需要考虑相似度度量的方式，最小哈希很适合当前的场景。

​	  最小哈希实际上就是将文档矩阵的每一列**进行重新排序**，并且使用第一个出现的非0行的行号作为这次哈希的值，即：
$$
h_{\pi}(C)=\min \pi(C)
$$
我们可以用多次不同的最小哈希得到文档的signature矩阵，每个文档为一列，每一列上有若干个最小哈希的结果值，同时最小哈希有一些很好的心智，我们可以证明：
$$
P(h_{\pi}(C_1)=h_{\pi}(C_2))=sim(C_1, C_2)
$$

#### 局部敏感性哈希

​	  最后一步是通过局部敏感性哈希来找到Jaccard相似度不低于某个阈值s的所有文档，基本的想法依然是使用哈希函数来





































